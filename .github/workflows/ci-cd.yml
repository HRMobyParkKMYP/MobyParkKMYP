name: FastAPI CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

env:
  APP_NAME: mobypark-api
  DOCKER_IMAGE: mobypark-api
  CONTAINER_PORT: 8000
  HOST_PORT: 8000
  WORKING_DIR: Parking-api-new
  DEPLOY_DIR: /opt/mobypark-deploy

jobs:
  test-build-deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify Docker access
        run: |
          echo "Checking Docker installation..."
          docker --version
          echo "Checking Docker daemon..."
          docker ps
          echo "Docker access verified ✓"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "Warning: requirements.txt not found"
          fi
      
      - name: Install test dependencies
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          pip install pytest pytest-cov pytest-asyncio httpx
      
      - name: Run tests
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          export PYTHONPATH="${PYTHONPATH}:$(pwd)/api"
          pytest test/ -v --cov=api --cov-report=term-missing || echo "Tests completed with warnings"
        continue-on-error: false
      
      - name: Build Docker image
        run: |
          docker build -f Parking-api-new/Dockerfile -t ${{ env.DOCKER_IMAGE }}:${{ github.sha }} ./Parking-api-new
          docker tag ${{ env.DOCKER_IMAGE }}:${{ github.sha }} ${{ env.DOCKER_IMAGE }}:latest
      
      - name: Prepare deployment directory
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "Creating deployment directory..."
          mkdir -p ${{ env.DEPLOY_DIR }}
          
          echo "Copying repository to deployment directory..."
          rsync -av --delete \
            --exclude '.git' \
            --exclude '_actions' \
            --exclude '_work' \
            ./ ${{ env.DEPLOY_DIR }}/
          
          echo "Repository copied to ${{ env.DEPLOY_DIR }}"
          ls -la ${{ env.DEPLOY_DIR }}
      
      - name: Stop old container
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          docker stop ${{ env.APP_NAME }} 2>/dev/null || true
          docker rm ${{ env.APP_NAME }} 2>/dev/null || true
      
      - name: Deploy new container
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          cd ${{ env.DEPLOY_DIR }}
          
          docker run -d \
            --name ${{ env.APP_NAME }} \
            --restart unless-stopped \
            -p ${{ env.HOST_PORT }}:${{ env.CONTAINER_PORT }} \
            -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            -e SECRET_KEY="${{ secrets.SECRET_KEY }}" \
            -v ${{ env.DEPLOY_DIR }}/${{ env.WORKING_DIR }}/parking.sqlite3:/app/parking.sqlite3 \
            ${{ env.DOCKER_IMAGE }}:latest
          
          echo "Waiting for container to start..."
          sleep 5
          
          # Check if container is running
          docker ps | grep ${{ env.APP_NAME }}
      
      - name: Health check
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          max_attempts=10
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:${{ env.HOST_PORT }}/ 2>/dev/null; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $((attempt+1))/$max_attempts failed, retrying..."
            sleep 3
            attempt=$((attempt+1))
          done
          
          echo "Health check failed after $max_attempts attempts"
          docker logs ${{ env.APP_NAME }}
          exit 1
      
      - name: Clean up old images
        if: always()
        run: |
          docker image prune -f
      
      - name: Show deployment info
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "✅ Deployment successful!"
          echo "Container: ${{ env.APP_NAME }}"
          echo "Port: ${{ env.HOST_PORT }}"
          docker ps --filter "name=${{ env.APP_NAME }}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"