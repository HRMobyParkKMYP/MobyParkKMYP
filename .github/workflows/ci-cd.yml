name: FastAPI CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

env:
  APP_NAME: mobypark-api
  DOCKER_IMAGE: mobypark-api
  CONTAINER_PORT: 8000
  HOST_PORT: 8000
  WORKING_DIR: Parking-api-new

jobs:
  test-build-deploy:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ${{ env.WORKING_DIR }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "Warning: requirements.txt not found"
          fi
      
      - name: Install test dependencies
        run: |
          pip install pytest pytest-cov pytest-asyncio httpx
      
      - name: Run tests
        run: |
          export PYTHONPATH="${PYTHONPATH}:$(pwd)/api"
          pytest test/ -v --cov=api --cov-report=term-missing || echo "Tests completed with warnings"
        continue-on-error: false
      
      - name: Build Docker image
        working-directory: .
        run: |
          docker build -f Parking-api-new/Dockerfile -t ${{ env.DOCKER_IMAGE }}:${{ github.sha }} ./Parking-api-new
          docker tag ${{ env.DOCKER_IMAGE }}:${{ github.sha }} ${{ env.DOCKER_IMAGE }}:latest
      
      - name: Stop old container
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          docker stop ${{ env.APP_NAME }} 2>/dev/null || true
          docker rm ${{ env.APP_NAME }} 2>/dev/null || true
      
      - name: Deploy new container
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          FERNET_KEY: ${{ secrets.FERNET_KEY }}
          API_HOST_IP: ${{ secrets.API_HOST_IP }}
          API_HOST_PORT: ${{ secrets.API_HOST_PORT }}
        run: |
          set -euo pipefail

          # Create a temp env-file readable only by current user
          umask 077
          ENV_FILE="$(mktemp)"
          trap 'rm -f "$ENV_FILE"' EXIT

          {
            printf 'FERNET_KEY=%s\n' "$FERNET_KEY"
            printf 'API_HOST_IP=%s\n' "$API_HOST_IP"
            printf 'API_HOST_PORT=%s\n' "$API_HOST_PORT"
          } > "$ENV_FILE"

          docker stop "${{ env.APP_NAME }}" 2>/dev/null || true
          docker rm "${{ env.APP_NAME }}" 2>/dev/null || true

          docker run -d \
            --name "${{ env.APP_NAME }}" \
            --restart unless-stopped \
            -p "${{ env.HOST_PORT }}:${{ env.CONTAINER_PORT }}" \
            --env-file "$ENV_FILE" \
            "${{ env.DOCKER_IMAGE }}:latest"
      
      - name: Health check
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          max_attempts=10
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:${{ env.HOST_PORT }}/ 2>/dev/null; then
              echo "Health check passed!"
              exit 0
            fi
            echo "Attempt $((attempt+1))/$max_attempts failed, retrying..."
            sleep 3
            attempt=$((attempt+1))
          done
          
          echo "Health check failed after $max_attempts attempts"
          docker logs ${{ env.APP_NAME }}
          exit 1
      
      - name: Clean up old images
        if: always()
        run: |
          docker image prune -f
      
      - name: Show deployment info
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "âœ… Deployment successful!"
          echo "Container: ${{ env.APP_NAME }}"
          echo "Port: ${{ env.HOST_PORT }}"
          docker ps --filter "name=${{ env.APP_NAME }}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
